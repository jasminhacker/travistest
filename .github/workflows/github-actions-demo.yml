name: Raveberry Deploy
on:
  push:
    paths-ignore:
      - 'docs/**'
      - '**.md'
jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.7'
          architecture: 'x64'
      - uses: actions/setup-node@v2
        with:
          node-version: 'lts/*'
          cache: 'yarn'
      - name: Install pip dependencies
        run: |
          pip install -U pip
          pip install -r requirements/ci.txt
      - run: yarn --cwd frontend install
      - run: yarn --cwd frontend build
      - run: yarn --cwd frontend test
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.7'
          architecture: 'x64'
      - name: Install pip dependencies
        run: |
          pip install -U pip
          pip install -r requirements/ci.txt
      - run: sudo apt-get -y install mopidy ffmpeg gstreamer1.0-plugins-bad
      - name: Prepare database
        run: |
          psql -c "CREATE USER raveberry WITH PASSWORD 'raveberry';"
          psql -c "CREATE DATABASE raveberry;"
          psql -c "ALTER USER raveberry CREATEDB;"
          python manage.py migrate
          python manage.py installwatson
          python manage.py buildwatson
      - name: Start mopidy
        run: |
          mopidy -o "audio/output=fakesink sync=true" &
          # wait for mopidy so it can handle connections
          sleep 5
      - python manage.py test

