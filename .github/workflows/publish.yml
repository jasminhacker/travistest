name: Publish Raveberry
on:
  push:
    paths-ignore:
      - 'docs/**'
      - '**.md'
jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:a
          node-version: 'lts/*'
      - run: pip install -r backend/requirements/frontend_build.txt
      - run: yarn --cwd frontend install
      - run: yarn --cwd frontend build
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-files
          path: |
            backend/static/bundle.js
            backend/static/style.css
            backend/static/*.woff2
  test-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      - uses: actions/download-artifact@v4
        with:
          name: frontend-files
          path: backend/static/
      - run: pip install -r backend/requirements/frontend_test.txt
      - run: yarn --cwd frontend install
      - run: yarn --cwd frontend test
  test-backend:
    runs-on: ubuntu-latest
    services:
      # from https://docs.github.com/en/actions/using-containerized-services/creating-postgresql-service-containers
      postgres:
        image: postgres
        env:
          POSTGRES_DB: raveberry
          POSTGRES_USER: raveberry
          POSTGRES_PASSWORD: raveberry
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      # from https://docs.github.com/en/actions/using-containerized-services/creating-redis-service-containers
      redis:
        image: redis
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      # in order to use the raveberry/raveberry-mopidy container,
      # we would need to share the songs cache. Instead, run mopidy on the host.
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install pip dependencies
        run: pip install -r backend/requirements/backend_test.txt
      - run: sudo apt-get update
      - run: sudo apt-get -y install ffmpeg mopidy gstreamer1.0-plugins-bad
      - name: Start mopidy
        run: |
          mopidy -o "audio/output=fakesink sync=true" &
          # wait for mopidy so it can handle connections
          sleep 5
      - name: Prepare database
        run: |
          python backend/manage.py migrate
      - run: python backend/manage.py test
  test-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install pip dependencies
        run: pip install -r backend/requirements/install.txt
      - run: sudo apt-get update
      - name: remove pyyaml
        run: |
          sudo rm -rf /usr/lib/python3/dist-packages/yaml
          sudo rm -rf /usr/lib/python3/dist-packages/PyYAML-*
      # https://stackoverflow.com/questions/73830524/attributeerror-module-lib-has-no-attribute-x509-v-flag-cb-issuer-check
      - name: Fix preinstalled apt dependencies
        run: |
          sudo apt-get --reinstall install python3-apt
          sudo apt-get --reinstall install apt-transport-https
          sudo apt-get install build-essential libssl-dev libffi-dev
      - name: Fix preinstalled pip dependencies
        run: sudo pip install pyopenssl --upgrade
      - run: sudo systemctl start postgresql
      - run: bin/raveberry --confirm-config --use-default-password-i-promise-ill-change-it install
      - name: Check if server is up
        run: |
          counter=0
          until [[ $(curl -sS http://localhost/api/version/) == "Raveberry version"* ]] || [ $counter -gt 30 ]
          do
            counter=$((counter + 1))
            sleep 1
          done
          # exit with failure if curl did not succeed in any iteration
          [ $counter != 31 ]
